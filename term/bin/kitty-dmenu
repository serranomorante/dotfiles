#!/usr/bin/env bash

if [[ $# -eq 1 ]]; then
    selected_path=$1
else
    uuid=$(uuidgen)
    kitty --class kitty-dmenu -o tab_bar_style=hidden sh -c "
        find \
        ~/data/pjs \
        ~/data/repos \
        ~/data/courses \
        ~/data/issues \
        ~/dotfiles \
        ~/.local/share/Cryptomator/mnt \
        ~/.local/share/nvim/site/pack/plugins/start \
        ~/.local/share/nvim/site/pack/plugins/opt \
        ~/.local/share/nvim/gp \
        ~/data/work/cf/repos \
        ~/data/work/gp/repos \
        ~/data/notes \
        -mindepth 1 -maxdepth 1 -type d | fzf --prompt='Select cwd: ' >/tmp/$uuid"
    selected_path=$(</tmp/$uuid)
fi

if [[ -z $selected_path ]]; then
    exit 0
fi

sockets=$(lsof -U 2>/dev/null | grep -oE @kitty-[0-9]+)
for socket in $sockets; do
    error_msg=$(kitten @ --to "unix:$socket" focus-window --match "cwd:^${selected_path}$" 2>&1) && exit 0 ||
        { [[ ! "$error_msg" =~ "No matching windows for expression" ]] && notify-send "Error: $error_msg"; }
done

kitty -d $selected_path
