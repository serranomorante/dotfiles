---
- name: "[archlinux] Setup ai tools: ensure figma-developer-mcp"
  ansible.builtin.shell: volta run --node {{ node_system_default_version }} $(volta which npm) install --global {{ item.name }}@latest
  changed_when: true
  when: fact_npm_global_outdated[item.name] is defined or fact_npm_global_installed.dependencies[item.name] is undefined
  loop:
    - name: mcp-hub
    - name: figma-developer-mcp
    - name: "@anthropic-ai/claude-code"
    - name: "@google/gemini-cli"

- name: "[archlinux] Setup ai tools: clone reaper mcp"
  ansible.builtin.git:
    repo: https://github.com/dschuler36/reaper-mcp-server
    dest: "{{ reaper_mcp_server_setup.repo_path }}"
    version: main

- name: "[archlinux] Setup ai tools: ensure reaper-mcp-server"
  ansible.builtin.shell: uv venv --seed && uv pip install . && uv pip install uv
  args:
    creates: "{{ reaper_mcp_server_setup.repo_path }}/.venv/bin/activate"
    chdir: "{{ reaper_mcp_server_setup.repo_path }}"

- name: "[archlinux] Setup ai tools: register figma api key"
  ansible.builtin.shell: gpg --homedir '{{ ansible_env.HOME }}/.gnupg' --decrypt ~/secrets/mcp-cf-figma.gpg 2>/dev/null
  changed_when: true
  register: mcp_server_figma_key

- name: "[archlinux] Setup ai tools: generate servers.json"
  ansible.builtin.template:
    src: mcphub_servers.json
    dest: ~/.config/mcphub/servers.json
    mode: "644"

- name: "[archlinux] Setup ai tools: restart server list"
  ansible.builtin.command: >
    nvim --headless -c "lua require("mcphub").get_hub_instance():restart()" -c "quit"
  changed_when: false
