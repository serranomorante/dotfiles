---
- name: "[archlinux] Setup ai tools: ensure mcp servers"
  ansible.builtin.shell: volta run --node {{ node_system_default_version }} $(volta which npm) install --global {{ item.name }}@{{ item.version | default('latest') }}
  changed_when: true
  when: fact_npm_global_outdated[item.name] is defined or fact_npm_global_installed.dependencies[item.name] is undefined
  loop:
    - name: mcp-hub
    - name: figma-developer-mcp
    - name: "@anthropic-ai/claude-code"
    - name: "@google/gemini-cli"
    - name: chrome-devtools-mcp
    - name: playwright
    - name: "@playwright/mcp"
    - name: mcp-figma-comment-summary

- name: "[archlinux] Setup ai tools: register playwright path"
  ansible.builtin.command: volta run --node "{{ node_system_default_version }}" which playwright
  register: var_playwright_global_path
  changed_when: false

- name: "[archlinux] Setup ai tools: symlink playwright"
  ansible.builtin.file:
    state: link
    src: "{{ var_playwright_global_path.stdout }}"
    dest: ~/bin/playwright

- name: "[archlinux] Setup ai tools: execute playwright install"
  ansible.builtin.command: playwright install
  environment:
    PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
  args:
    creates: ~/.cache/ms-playwright/chromium-*/INSTALLATION_COMPLETE

- name: "[archlinux] Setup ai tools: clone reaper mcp"
  ansible.builtin.git:
    repo: https://github.com/dschuler36/reaper-mcp-server
    dest: "{{ reaper_mcp_server_setup.repo_path }}"
    version: main

- name: "[archlinux] Setup ai tools: ensure reaper-mcp-server"
  ansible.builtin.shell: uv venv --seed && uv pip install . && uv pip install uv
  args:
    creates: "{{ reaper_mcp_server_setup.repo_path }}/.venv/bin/activate"
    chdir: "{{ reaper_mcp_server_setup.repo_path }}"

- name: "[archlinux] Setup ai tools: register figma api key"
  ansible.builtin.shell: gpg --homedir '{{ ansible_env.HOME }}/.gnupg' --decrypt ~/secrets/mcp-cf-figma.gpg 2>/dev/null
  changed_when: true
  register: mcp_server_figma_key

- name: "[archlinux] Setup ai tools: register playwright_mcp_browser_key"
  ansible.builtin.shell: gpg --homedir '{{ ansible_env.HOME }}/.gnupg' --decrypt ~/secrets/playwright_mcp_browser_key.gpg 2>/dev/null
  changed_when: true
  register: var_playwright_mcp_browser_key

- name: "[archlinux] Setup ai tools: generate servers.json"
  ansible.builtin.template:
    src: mcphub_servers.json
    dest: ~/.config/mcphub/servers.json
    mode: "644"
  register: var_mcp_hub_servers_json

- name: "[archlinux] Setup ai tools: restart server list"
  ansible.builtin.command: >
    nvim --headless -c "lua require("mcphub").get_hub_instance():restart()" -c "quit"
  changed_when: true
  when: var_mcp_hub_servers_json.changed
