---
- name: "[archlinux] Setup security tools: ensure packages"
  become: true
  ansible.builtin.package:
    state: present
    name:
      - kwallet
      - kwalletmanager
      - ufw
      - ksshaskpass
      - tcpdump
      - bustle

- name: "[archlinux] Other tools: ensure kwalletcli folder"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "755"
  loop:
    - ~/data/apps/security-tools
    - ~/data/apps/security-tools/kwalletcli

- name: "[archlinux] Other tools: download pre-compiled kwalletcli"
  ansible.builtin.unarchive:
    src: https://gitlab.com/stefanwimmer128/pkgbuilds/-/package_files/188019197/download
    dest: ~/data/apps/security-tools/kwalletcli/
    remote_src: true

- name: "[archlinux] Other tools: symlink kwalletcli"
  ansible.builtin.file:
    src: ~/data/apps/security-tools/kwalletcli/usr/bin/{{ item }}
    dest: ~/bin/{{ item }}
    state: link
  loop:
    - kwalletaskpass
    - kwalletcli_getpin
    - kwalletcli
    - pinentry-kwallet

- name: "[archlinux] Setup security tools: enable services"
  ansible.builtin.systemd_service:
    scope: user
    name: ssh-agent.service
    enabled: true
    masked: false

# https://wiki.archlinux.org/title/SSH_keys#Start_ssh-agent_with_systemd_user
- name: "[archlinux] Setup security tools: setup shell startup scripts"
  ansible.builtin.blockinfile:
    marker: "## {mark} ANSIBLE MANAGED BLOCK - SETUP ENCRYPTION"
    dest: "{{ item.script }}"
    create: true
    mode: "744"
    block: |
      {% if 'dot-bashrc' in item.script %}
      export SSH_AUTH_SOCK="$XDG_RUNTIME_DIR/ssh-agent.socket"
      {% endif %}
  loop:
    - { script: ~/dotfiles/home/dot-bashrc }

- name: "[archlinux] Setup security tools: default deny incoming"
  become: true
  community.general.ufw:
    default: deny
    direction: incoming

- name: "[archlinux] Setup security tools: default allow outgoing"
  become: true
  community.general.ufw:
    default: allow
    direction: outgoing

- name: "[archlinux] Setup security tools: setup ufw"
  # From: /etc/ufw/applications.d
  become: true
  community.general.ufw:
    rule: allow
    name: "{{ item }}"
  loop:
    - SSH
    - WWW Full

- name: "[archlinux] Setup security tools: enable ufw"
  become: true
  community.general.ufw:
    state: enabled

- name: "[archlinux] Setup security tools: get nvim keyrings"
  ansible.builtin.shell: >
    nvim --headless +'lua =io.stdout:write(vim.json.encode(require("serranomorante.constants").KEYRINGS) .. "\n")' +q 2>/dev/null
  changed_when: false
  ignore_errors: true
  register: var_nvim_keyrings

- name: "[archlinux] Setup security tools: get private nvim keyrings"
  ansible.builtin.shell: >
    nvim --headless +'lua =io.stdout:write(vim.json.encode(require("serranomorante.private-constants").KEYRINGS) .. "\n")' +q 2>/dev/null
  changed_when: false
  ignore_errors: true
  register: var_private_nvim_keyrings

- name: "[archlinux] Setup security tools: set keyrings fact"
  ansible.builtin.set_fact:
    keyrings: "{{ (keyrings | default([])) + ((var_nvim_keyrings.stdout | from_json).values() | list) }}"
  when: var_nvim_keyrings is success

- name: "[archlinux] Setup security tools: set private keyrings fact"
  ansible.builtin.set_fact:
    keyrings: "{{ (keyrings | default([])) + ((var_private_nvim_keyrings.stdout | from_json).values() | list) }}"
  when: var_private_nvim_keyrings is success

- name: "[archlinux] Setup security tools: set borg keyrings facts"
  ansible.builtin.set_fact:
    keyrings: "{{ (keyrings | default([])) | union(item | map(attribute='keyrings')) }}"
  loop:
    - "{{ archlinux_borg_repos_env }}"
    - "{{ archlinux_borg_root_repos_env }}"

- name: "[archlinux] Setup security tools: set dev-tools keyrings facts"
  ansible.builtin.set_fact:
    keyrings: "{{ keyrings | default([]) + [item.keyrings] }}"
  loop:
    - "{{ figma_mcp_server_setup }}"
    - "{{ figma_mcp_commentary_server_setup }}"
    - "{{ playwright_mcp_server_setup }}"

- name: "[archlinux] Setup security tools: stat setup-kwallet"
  ansible.builtin.stat:
    path: ~/dotfiles/for-my-eyes-only/playbooks/roles/80-for-my-eyes-only/templates/setup-kwallet
  register: var_stat_setup_kwallet

- name: "[archlinux] Setup security tools: setup-kwallet passwords"
  ansible.builtin.template:
    src: ../../../../for-my-eyes-only/playbooks/roles/80-for-my-eyes-only/templates/setup-kwallet
    dest: ~/bin/setup-kwallet
    mode: "755"
  vars:
    keyrings: "{{ keyrings }}"
  when: var_stat_setup_kwallet.stat.exists

- name: "[archlinux] Setup security tools: setup secrets service"
  # https://wiki.archlinux.org/title/KDE_Wallet#Automatic_D-Bus_activation
  ansible.builtin.copy:
    src: org.freedesktop.secrets.service
    dest: ~/.local/share/dbus-1/services/org.freedesktop.secrets.service
    mode: "644"
