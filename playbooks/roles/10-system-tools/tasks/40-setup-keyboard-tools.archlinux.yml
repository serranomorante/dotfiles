---
- name: "Keyboard peripheral: ensure sxhkd is present"
  become: true
  ansible.builtin.package:
    state: present
    name: sxhkd

- name: "Keyboard peripheral: enable service sxhkd and ensure is not masked"
  ansible.builtin.systemd_service:
    scope: user
    state: started
    name: sxhkd
    enabled: true
    masked: false

- name: "Keyboard peripheral: ensure keyd is present"
  ansible.builtin.package:
    state: present
    name: keyd

- name: "Keyboard peripheral: enable services"
  ansible.builtin.systemd_service:
    scope: "{{ service.scope }}"
    name: "{{ service.name }}"
    state: started
    enabled: true
    masked: false
  loop:
    - { name: keyd, scope: system }
    - { name: kbdrate, scope: user }
  loop_control:
    loop_var: service

- name: "Keyboard peripheral: copy keyd default.conf file"
  become: true
  ansible.builtin.copy:
    src: ~/.config/keyd/default.conf
    dest: /etc/keyd/default.conf
    owner: root
    mode: "644"

- name: "Keyboard peripheral: kbdrate udev rule"
  become: true
  ansible.builtin.shell: >
    set -o pipefail &&
    echo 'SUBSYSTEM=="usb", ATTRS{idVendor}=="8087", ATTRS{idProduct}=="0029",
    TAG+="systemd", ENV{SYSTEMD_USER_WANTS}+="kbdrate.service"' |
    sudo tee /etc/udev/rules.d/99-kbdrate.rules
  args:
    creates: /etc/udev/rules.d/99-kbdrate.rules
