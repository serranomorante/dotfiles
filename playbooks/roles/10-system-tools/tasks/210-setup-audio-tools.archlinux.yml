---
- name: "[archlinux] Setup audio tools: ensure no package conflicts"
  become: true
  ansible.builtin.package:
    state: absent
    name:
      - plasma-pa
      - pulseaudio

- name: "[archlinux] Setup audio tools: ensure aur packages"
  become: true
  become_user: aur_builder
  aur:
    use: yay
    state: present
    name: patchance

- name: "[archlinux] Setup audio tools: remove conflicting packages"
  become: true
  ansible.builtin.package:
    force: true
    state: absent
    name:
      - jack
      - jack2

- name: "[archlinux] Setup audio tools: ensure packages"
  become: true
  ansible.builtin.package:
    state: present
    name:
      - pipewire
      - lib32-pipewire
      - pipewire-docs
      - pipewire-audio
      - pipewire-alsa
      - pipewire-pulse
      - pipewire-jack
      - lib32-pipewire-jack
      - wireplumber
      - plasma-pa
      - realtime-privileges
      - base-devel
      - cpupower
      - helvum
      - alsa-utils
      - python-qtpy
      - rtirq
      - reaper
  notify: handler_ensure_rtirq_service

- name: "[archlinux] Setup audio tools: setup reaper-linux.desktop file"
  ansible.builtin.template:
    src: reaper-linux.desktop
    dest: ~/.local/share/applications/
    mode: "644"
  notify: handler_update_desktop_database

- name: "[archlinux] Setup audio tools: ensure user services"
  ansible.builtin.systemd_service:
    scope: user
    name: "{{ item.name }}"
    enabled: "{{ item.enabled }}"
    masked: "{{ item.masked }}"
  loop:
    - { name: pipewire.socket, enabled: true, masked: false }
    - { name: pipewire-pulse.socket, enabled: true, masked: false }
    - { name: wireplumber.service, enabled: true, masked: false }


- name: "[archlinux] Setup audio tools: create pipewire group"
  become: true
  ansible.builtin.group:
    name: pipewire

- name: "[archlinux] Setup audio tools: add user to realtime and audio groups"
  become: true
  ansible.builtin.user:
    append: true
    groups:
      - realtime
      - audio
      - pipewire
    name: "{{ ansible_facts.env.USER }}"

- name: "[archlinux] Setup audio tools: ensure path"
  ansible.builtin.file:
    path: /etc/sysctl.d/
    state: directory
    mode: "755"

- name: "[archlinux] Setup audio tools: max user freq"
  # https://wiki.archlinux.org/title/Professional_audio#Optimizing_system_configuration
  become: true
  ansible.builtin.command: "{{ item }}"
  changed_when: true
  loop:
    - echo 2048 > /sys/class/rtc/rtc0/max_user_freq
    - echo 2048 > /proc/sys/dev/hpet/max-user-freq
    - setpci -v -d *:* latency_timer=b0
    - setpci -v -s 06:00.6 latency_timer=ff

- name: "[archlinux] Setup audio tools: setup swappiness"
  become: true
  ansible.builtin.copy:
    src: 90-swappiness.conf
    dest: /etc/sysctl.d/90-swappiness.conf
    mode: "644"

- name: "[archlinux] Setup audio tools: setup max user watches"
  become: true
  ansible.builtin.copy:
    src: 90-max_user_watches.conf
    dest: /etc/sysctl.d/90-max_user_watches.conf
    mode: "644"

- name: "[archlinux] Setup audio tools: enable threadirqs"
  become: true
  ansible.builtin.copy:
    src: audio.conf
    dest: /etc/cmdline.d/audio.conf
    mode: "644"

- name: "[archlinux] Setup audio tools: stat cpupower config file"
  become: true
  ansible.builtin.stat:
    path: /etc/default/cpupower-service.conf
  register: var_cpupower

- name: "[archlinux] Setup audio tools: governor performance"
  become: true
  ansible.builtin.replace:
    path: "{{ var_cpupower.stat.path }}"
    regexp: "^#GOVERNOR=.*"
    replace: "GOVERNOR='performance'"
  when: var_cpupower.stat.exists

- name: "[archlinux] Setup audio tools: ensure system services"
  become: true
  ansible.builtin.systemd_service:
    scope: system
    name: "{{ item }}"
    enabled: true
    masked: false
  loop:
    - cpupower.service
    - bluetooth.service
