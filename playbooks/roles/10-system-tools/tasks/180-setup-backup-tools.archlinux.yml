---
- name: "Setup backup tools: ensure packages"
  become: true
  ansible.builtin.package:
    state: present
    name:
      - borg
      - vorta

- name: "Setup backup tools: ensure borg env variables in sudoers file"
  become: true
  ansible.builtin.blockinfile:
    dest: /etc/sudoers
    marker: "## {mark} ANSIBLE MANAGED BLOCK - SETUP BORG"
    block: Defaults env_keep += "BORG_*"
    validate: visudo -cf %s

- name: "Setup backup tools: ensure configuration-backups folder"
  ansible.builtin.file:
    state: directory
    recurse: true
    path: ~/configuration-backups

- name: "Setup backup tools: bootstrap borg config repo"
  ansible.builtin.shell: |
    export BORG_PASSCOMMAND='gpg --decrypt {{ ansible_env.HOME }}/borg_passphrase.gpg'
    borg init --encryption=repokey --make-parent-dirs {{ ansible_env.HOME }}/configuration-backups
  args:
    creates: ~/configuration-backups/config

- name: "Setup backup tools: register borg path"
  ansible.builtin.command: which borg
  register: borg_executable_path
  changed_when: false

- name: "Setup backup tools: auto generate borg-backup service"
  ansible.builtin.blockinfile:
    dest: ~/dotfiles/systemd/dot-config/systemd/user/borg-backup.service
    create: true
    insertafter: '^\[Service\]'
    marker: "## {mark} ANSIBLE MANAGED BLOCK - SETUP BORG BACKUP"
    block: >
      ExecStart={{ borg_executable_path.stdout }}
      create
      %h/configuration-backups::archive-{now:%%Y-%%m-%%d_%%H_%%M_%%S} {{ systemd_config_backups_dirs | join(' ') }}
    mode: "644"

- name: "Setup backup tools: ensure borg backup timer"
  ansible.builtin.systemd_service:
    scope: user
    name: borg-backup.timer
    state: started
    enabled: true
    masked: false
