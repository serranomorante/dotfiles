---
- name: "Setup backup tools: ensure packages"
  become: true
  ansible.builtin.package:
    state: present
    name:
      - borg
      - vorta

- name: "Setup backup tools: ensure home-config-data-backups folder"
  ansible.builtin.file:
    state: directory
    recurse: true
    path: ~/home-config-data-backups

- name: "Setup backup tools: bootstrap borg config repo"
  ansible.builtin.shell: |
    export BORG_PASSCOMMAND='gpg --decrypt {{ ansible_env.HOME }}/borg_passphrase.gpg'
    borg init --encryption=repokey {{ ansible_env.HOME }}/home-config-data-backups
  args:
    creates: ~/home-config-data-backups/config

- name: "Setup backup tools: register borg path"
  ansible.builtin.command: which borg
  register: borg_executable_path
  changed_when: false

- name: "Setup backup tools: auto generate borg-backup service"
  ansible.builtin.blockinfile:
    dest: ~/dotfiles/systemd/dot-config/systemd/user/borg-backup.service
    create: true
    insertafter: '^\[Service\]'
    marker: "## {mark} ANSIBLE MANAGED BLOCK - SETUP BORG BACKUP"
    block: >
      ExecStart={{ borg_executable_path.stdout }}
      create
      %h/home-config-data-backups::home-config-data-archive-{now:%%Y-%%m-%%d_%%H_%%M_%%S} %h/{{ home_config_data_backups | join(' %h/') }}
    mode: "644"

- name: "Setup backup tools: ensure borg backup timer"
  ansible.builtin.systemd_service:
    scope: user
    name: borg-backup.timer
    state: started
    enabled: true
    masked: false
