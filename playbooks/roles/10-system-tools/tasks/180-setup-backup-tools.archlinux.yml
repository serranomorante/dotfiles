---
- name: "[archlinux] Setup backup tools: ensure packages"
  become: true
  ansible.builtin.package:
    state: present
    name:
      - borg
      - vorta

# https://borgbackup.readthedocs.io/en/stable/quickstart.html#pitfalls-with-shell-variables-and-environment-variables
- name: "[archlinux] Setup backup tools: ensure borg env variables in sudoers file"
  become: true
  ansible.builtin.blockinfile:
    dest: /etc/sudoers
    marker: "## {mark} ANSIBLE MANAGED BLOCK - SETUP BORG"
    block: Defaults env_keep += "BORG_*"
    validate: visudo -cf %s

- name: "[archlinux] Setup backup tools: init borg repos"
  ansible.builtin.shell: |
    export BORG_PASSCOMMAND='gpg --decrypt {{ ansible_env.HOME }}/secrets/{{ item.encrypted_passphrase_file }}'
    export BORG_REPO='{{ item.borg_repo }}'
    borg init --encryption=keyfile --make-parent-dirs
  loop:
    - { borg_repo: "{{ dev1_config_files_borg_repo }}", encrypted_passphrase_file: staunch4647.gpg }
    - { borg_repo: "{{ dev1_pkm_borg_repo }}", encrypted_passphrase_file: feed4999.gpg }
    - { borg_repo: "{{ dev2_config_files_borg_repo }}", encrypted_passphrase_file: staunch4647.gpg }
    - { borg_repo: "{{ dev2_pkm_borg_repo }}", encrypted_passphrase_file: feed4999.gpg }
    - { borg_repo: "{{ dev3_config_files_borg_repo }}", encrypted_passphrase_file: staunch4647.gpg }
    - { borg_repo: "{{ dev3_pkm_borg_repo }}", encrypted_passphrase_file: feed4999.gpg }
  changed_when: false
  register: result
  failed_when: '"stderr" in result and "A repository already exists" not in result.stderr and "gpg: encrypted with" not in result.stderr'

- name: "[archlinux] Setup backup tools: create backup scripts from template"
  ansible.builtin.template:
    src: ~/dotfiles/assets/scripts/backup/borg_backup_jinja_template.backup.sh
    dest: ~/bin/{{ item.name }}.backup.sh
    mode: "744"
  vars:
    borg_repo: "{{ item.repo }}"
    borg_pass: "{{ item.pass }}"
    files: "{{ item.files }}"
  loop:
    - { name: autogenerated-dev1-config-files, repo: "{{ dev1_config_files_borg_repo }}", pass: staunch4647.gpg, files: "{{ config_files_backup_env }}" }
    - { name: autogenerated-dev1-PKM, repo: "{{ dev1_pkm_borg_repo }}", pass: feed4999.gpg, files: "{{ pkm_backup_env }}" }
    - { name: autogenerated-dev2-config-files, repo: "{{ dev2_config_files_borg_repo }}", pass: staunch4647.gpg, files: "{{ config_files_backup_env }}" }
    - { name: autogenerated-dev2-PKM, repo: "{{ dev2_pkm_borg_repo }}", pass: feed4999.gpg, files: "{{ pkm_backup_env }}" }
    - { name: autogenerated-dev3-config-files, repo: "{{ dev3_config_files_borg_repo }}", pass: staunch4647.gpg, files: "{{ config_files_backup_env }}" }
    - { name: autogenerated-dev3-PKM, repo: "{{ dev3_pkm_borg_repo }}", pass: feed4999.gpg, files: "{{ pkm_backup_env }}" }

- name: "[archlinux] Setup backup tools: ensure borg backup timer"
  ansible.builtin.systemd_service:
    scope: user
    name: "{{ item.service }}.timer"
    state: started
    enabled: true
    masked: false
  loop:
    - { service: dev1-config-files }
    - { service: dev1-PKM }
    - { service: dev2-config-files }
    - { service: dev2-PKM }
    - { service: dev3-config-files }
    - { service: dev3-PKM }
